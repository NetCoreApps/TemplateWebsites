<!--
title: Search Redis
-->

{{ limit | default(100) | assignTo: limit }}
{{ q     | default('')  | assignTo: q }}
{{ key   | default('')  | assignTo: key }}
{{ "?"   | addQueryString({ q, limit }) | assignTo: baseUrl }}

{{ `<script>
var baseUrl = "{0}";
var key = "{1}";
var limit = "{2}";
</script>` | fmt(baseUrl, key, limit) | raw }}

{{ `<script>
$('input[name=q]').on('input', function(){ $(this).closest('form').submit() })

$('.details tbody tr').on('click', function(){
    var key = $(this).find('td:first').html()
    var type = $(this).find('td:nth-child(2)').html()
    var call = type == "string" ?
        "GET " + key
        : type == "list" ? 
        "LRANGE " + key + " 0 -1"
        : type == "set" ?
        "SMEMBERS " + key
        : type == "zset" ?
        "ZRANGE " + key + " 0 -1 WITHSCORES" 
        : type == "hash" ?
        "HGETALL " + key  : null;
    location.href = baseUrl + '&key=' + encodeURIComponent(key) + "&type=" + type + "&call=" + encodeURIComponent(call)
})

$('.action.edit').on('click', function(){
    if (!key) return
    $('#setKey').val(key)
    $('#setValue').val(window.keyValue)
})

$('.action.delete').on('click', function(){
    location.href = baseUrl + '&call=' + encodeURIComponent("DEL " + key)
})

$('.action.q').on('click', function(){
    location.href = '?q=' + encodeURIComponent(key.split(':').slice(0, $(this).data('pos') + 1).join(':'))
})

$('#setKey,#setValue').on('input', function(){
    var newKey = $('#setKey').val()
    $(this).closest('form').find('button').attr('disabled', !newKey || (newKey == key && $('#setValue').val() == window.keyValue))
    $('#setKey').val(newKey.replace(/\s+/g,''))
})

$('#create-key').submit(function(e){
    e.preventDefault()
    var key = $('#setKey').val()
    location.href = '?q=' + key + '&call=' + encodeURIComponent("SET " + key + " " + $('#setValue').val())
})

$("#search-results tr td:first-child").each(function(){
    if ($(this).html() == key) $(this).parent().addClass('active')
})
</script>` | raw | assignTo: scripts }}

<form role="search" class="form-inline">
    <div class="form-group">
        <div class="input-group input-group-lg">
            <input type="text" name="q" class="form-control" placeholder="Search for key, e.g. urn..." aria-label="Search for key..." value="{{ q }}"
                   autofocus onfocus="var hold=this.value; this.value=''; this.value=hold"
                   autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>
        <div class="col-auto"></div>
        <div class="input-group input-group-lg">
            <input type="text" name="limit" class="form-control" placeholder="limit" value="{{ limit }}" style="width:80px;"
                   autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>
        <div class="col-auto">
            <label for="limit">results</label>
        </div>
    </div>
    <div class="form-group">
        <div class="input-group input-group-lg">
            <input type="text" name="call" class="form-control" placeholder="Redis Command" value="{{ call | ifExists }}" style="min-width:410px"
                   autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <span class="input-group-btn">
                <button class="btn btn-secondary" type="submit">Go!</button>
            </span>
        </div>
    </div>
</form>

{{ ['flush','monitor','brpop','blpop'] | ifNotEmpty(call) | any: contains(lower(call), it)
   | assignTo: illegalCommand }}

{{ call | endIfEmpty | endIf(illegalCommand) | redisCall | assignTo: json }}
{{ json | endIfEmpty | parseJson | default(json) | assignTo: obj }}

<script>window.keyValue = '{{ json | jsString }}';</script>

<div style="position:absolute;margin-left:465px;max-width:900px;padding-right:20px">
    {{ illegalCommand | ifDo | select: <h3 class="text-danger">Command is not allowed.</h3> }}

    <table class="table table-bordered auto-width">
        <caption>
        {{ key   | ifExists(obj)  | split(':')   | assignTo: parts }}
        {{ parts | hasMinCount(2) | ifUse(parts) | select: { '>' | if(!isZero(index)) }<span class='action q' data-pos='{ index }'>{ it }</span> }}
        </caption>

        {{ obj  | endIfEmpty | htmlDump({ className: "table table-striped" }) | assignTo: html }}
        {{ html | ifExists   | select: <tr><td>{ it }</td></tr> }}

        {{ ['edit','delete'] | useIf(and(!isEmpty(obj), equals(type,'string'))) | select: <span class='action {it}'>{it}</span>
           | assignTo: actions }}
        {{ actions | select: <tr><td colspan="2" style="text-align:right">{ actions | raw }</td></tr> }}            
    </table>

    <form id="create-key" style="margin-top:40px">
        <h3>Set Key</h3>
        <div class="form-group">
            <div class="input-group input-group-lg">
                <input id="setKey" type="text" class="form-control" placeholder="Key" value="" style="min-width:400px"
                    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            </div>
        </div>
        <div class="form-group">
            <div class="input-group input-group-lg">
                <textarea id="setValue" class="form-control" placeholder="Value" value="" style="min-width:400px;min-height:200px"
                    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
            </div>
        </div>
        <div class="form-group">
            <span class="input-group-btn">
                <button class="btn btn-secondary" disabled>Submit</button>
            </span>
        </div>
    </form>

</div>

<div id="search-results">
    {{ q | endIfEmpty | append("*") | redisSearchKeys({ limit }) | map: toObjectDictionary(it) 
        | assignTo: searchResults }}
    {{ q| endIfEmpty | select: <h3>Results for '{ it }'</h3> }}
    {{ searchResults | useIf(isList(searchResults))      | htmlDump({ className: "table table-striped details auto-width" }) }}
    {{ searchResults | endIfNotEmpty | doIf(!isEmpty(q)) | select: Your search did not match any keys.. }}
</div>