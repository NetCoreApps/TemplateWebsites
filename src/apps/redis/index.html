<!--
title: Search Redis
-->

{{ limit | default(100) | assignTo: limit }}
{{ q     | default('')  | assignTo: q }}
{{ key   | default('')  | assignTo: key }}
{{ call  | ifExists     | otherwise(iif(!isEmpty(key), fmt('GET {0}', key), '')) | assignTo: call }}
{{ "?"   | addQueryString({ q, limit }) | assignTo: baseUrl }}

{{ `<script>
var baseUrl = "{0}";
var key = "{1}";
var limit = "{2}";
</script>` | fmt(baseUrl, key, limit) | raw }}

{{ `<script>
$('input[name=q]').on('input', function(){ $(this).closest('form').submit() })

$('.details tbody tr').on('click', function(){
    var key = $(this).find('td:first').html()
    location.href = baseUrl + '&key=' + encodeURIComponent(key)
})

$('.action.edit').on('click', function(){
    if (!key) return
    $('#setKey').val(key)
    $('#setValue').val(window.keyValue)
})

$('.action.delete').on('click', function(){
    location.href = baseUrl + '&call=' + encodeURIComponent("DEL " + key)
})

$('.action.q').on('click', function(){
    location.href = '?q=' + encodeURIComponent(key.split(':').slice(0, $(this).data('pos') + 1).join(':'))
})

$('#setKey,#setValue').on('input', function(){
    var newKey = $('#setKey').val()
    $(this).closest('form').find('button').attr('disabled', !newKey || (newKey == key && $('#setValue').val() == window.keyValue))
    $('#setKey').val(newKey.replace(/\s+/g,''))
})

$('#create-key').submit(function(e){
    e.preventDefault()
    var key = $('#setKey').val()
    location.href = '?q=' + key + '&call=' + encodeURIComponent("SET " + key + " " + $('#setValue').val())
})
</script>` | raw | assignTo: scripts }}

<form role="search" class="form-inline">
    <div class="form-group">
        <div class="input-group input-group-lg">
            <input type="text" name="q" class="form-control" placeholder="Search for key, e.g. urn..." aria-label="Search for key..." value="{{ q }}"
                   autofocus onfocus="var hold=this.value; this.value=''; this.value=hold"
                   autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <span class="input-group-btn">
                <button class="btn btn-secondary" type="submit">Go!</button>
            </span>
        </div>
        <div class="col-auto"></div>
        <div class="input-group input-group-lg">
            <input type="text" name="limit" class="form-control" placeholder="limit" value="{{ limit }}" style="width:80px;"
                   autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>
        <div class="col-auto">
            <label for="limit">results</label>
        </div>
    </div>
    <div class="form-group">
        <div class="input-group input-group-lg">
            <input type="text" name="call" class="form-control" placeholder="Redis Command" value="{{ call | ifExists }}" style="min-width:340px; max-width:400px"
                   autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <span class="input-group-btn">
                <button class="btn btn-secondary" type="submit">Go!</button>
            </span>
        </div>
    </div>
</form>

{{ ['flush','monitor','brpop','blpop'] | any: contains(lower(call), it)
   | assignTo: illegalCommand }}

{{ illegalCommand | ifDo | select: <p class="text-danger">Command is not allowed.</p> }}

{{ q    | endIfEmpty | select: <h3>Results for '{ it }'</h3> }}
{{ call | endIf(or(isEmpty(call), illegalCommand)) | redisCall | assignTo: json }}
{{ json | endIfEmpty | parseJson | default(json) | assignTo: obj }}

<script>window.keyValue = '{{ json | jsString }}';</script>

<div style="position:absolute;margin-left:535px;max-width:620px">

    <table class="table table-bordered auto-width">
        <caption>
        {{ key   | ifExists(obj)  | split(':')   | assignTo: parts }}
        {{ parts | hasMinCount(2) | ifUse(parts) | select: { '>' | if(!isZero(index)) }<span class='action q' data-pos='{ index }'>{ it }</span> }}
        </caption>

        {{ obj | useIf(isDictionary(obj)) | toList | select: <tr><th>{ it.Key }</th><td>{ it.Value }</td> }}
        {{ obj | useIf(isList(obj))       | toList | select: <tr><td>{ it | htmltable }</td> }}
        {{ obj | endIf(or(isDictionary(obj), isList(obj))) | select: <tr><td colspan="2">{ it }</td></tr> }}

        {{ ['edit','delete'] | useIf(!isEmpty(key)) | select: <span class='action {it}'>{it}</a>
           | assignTo: actions }}
        {{ actions | select: <tr><td colspan="2" style="text-align:right">{ actions | raw }</td></tr> }}            
    </table>

    <form id="create-key" style="margin:40px 0 0 0">
        <h3>Set Key</h3>
        <div class="form-group">
            <div class="input-group input-group-lg">
                <input id="setKey" type="text" class="form-control" placeholder="Key" value="" style="min-width:400px"
                    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            </div>
        </div>
        <div class="form-group">
            <div class="input-group input-group-lg">
                <textarea id="setValue" class="form-control" placeholder="Value" value="" style="min-width:400px;min-height:200px"
                    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
            </div>
        </div>
        <div class="form-group">
            <span class="input-group-btn">
                <button class="btn btn-secondary" disabled>Submit</button>
            </span>
        </div>
    </form>

</div>

{{ q | endIfEmpty | append("*") | redisSearchKeys({ limit }) | map: toObjectDictionary(it) 
     | assignTo: results }}

{{ results | isList | ifUse(results) | htmltable({ className: "table table-striped details auto-width" }) }}

{{ "Your search did not match any keys." | if(and(isEmpty(results), !isEmpty(q))) }}