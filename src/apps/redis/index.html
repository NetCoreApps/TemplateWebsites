<!--
title: Search Redis
-->

{{ limit | default(100) | assignTo: limit }}
{{ q     | default('')  | assignTo: q }}
{{ key   | default('')  | assignTo: key }}
{{ call  | exists | iif(call, iif(!isEmpty(key), fmt('GET {0}', key), '')) | assignTo: call }}
{{ "?"  | addQueryString({ q, limit }) | assignTo: baseUrl }}

<style>
    form {
        padding: 20px 0;
    }
</style>

{{ `<script>
var baseUrl = "{0}";
var key = "{1}";
var limit = "{2}";
</script>` | fmt(baseUrl, key, limit) | raw }}

{{ `<script>
$('input[name=q]').on('input', function(){ $('form').submit() })

$('.details tbody tr').on('click', function(){
    var key = $(this).find('td:first').html();
    location.href = baseUrl + '&key=' + encodeURIComponent(key);
})

$('.action.delete').on('click', function(){
    location.href = baseUrl + '&call=' + encodeURIComponent("DEL " + key);
})

$('.action.navkey').on('click', function(){
    location.href = '?q=' + encodeURIComponent(key.split(':').slice(0, $(this).data('pos') + 1).join(':'));
})
</script>` | raw | assignTo: scripts }}

<form role="search" class="form-inline">
    <div class="form-group">
        <div class="input-group input-group-lg">
            <input type="text" name="q" class="form-control" placeholder="Search for key..." aria-label="Search for key..." value="{{ q }}"
                   autofocus onfocus="var hold=this.value; this.value=''; this.value=hold"
                   autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <span class="input-group-btn">
                <button class="btn btn-secondary" type="submit">Go!</button>
            </span>
        </div>
        <div class="col-auto"></div>
        <div class="input-group input-group-lg">
            <input type="text" name="limit" class="form-control" placeholder="limit" value="{{ limit }}" style="width:80px;"
                   autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>
        <div class="col-auto">
            <label for="limit">results</label>
        </div>
    </div>
    <div class="form-group">
        <div class="input-group input-group-lg">
            <input type="text" name="call" class="form-control" placeholder="Redis Command" value="{{ call | ifExists }}" style="min-width:340px; max-width:400px"
                   autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <span class="input-group-btn">
                <button class="btn btn-secondary" type="submit">Go!</button>
            </span>
        </div>
    </div>
</form>

{{ q | ifNotEmpty | select: <h3>Results for '{ it }'</h3> }}

{{ call | ifExists | redisCall | jsonToObjectDictionary | assignTo: obj }}

<div style="position:absolute;margin-left:535px;max-width:620px">
    <table class="table table-bordered auto-width">
        {{ obj | ifNotEmpty | toList | select: <tr><th>{ it.Key }</th><td>{ it.Value }</td> }}
        {{ obj | ifNotEmpty | select: <tr><td colspan="2" style="text-align:right"><span class='action delete'>delete</a></td></tr> }}            
    </table>

    <div class="breadcrumbs">
        {{ key | ifNotEmpty(obj) | split(':') | select: { '<b> / </b>' | if(gt(index,0)) | raw }<span class='action navkey' data-pos='{ index }'>{ it }</span> }}
    </div>
</div>

{{ "{0}*" | fmt(q) | ifNotEmpty(q) | redisSearchKeys({ limit }) | map: toObjectDictionary(it) 
   | assignTo: results }}

{{ results | htmltable({ className: "table table-striped details auto-width" }) }}

{{ "Your search did not match any keys." | ifEmpty(results) | ifNotEmpty(q) }}

